# 异常处理与系统调试评估报告

**相关成员**：Member B (数据看板/时空分析)
**报告日期**：2026-01-06

## 1. 概述
在集成《山东省非物质文化遗产可视化演示系统》的数据看板模块时，遇到了由于数据标准不统一、接口调用链路不完整、项目文件配置失误等导致的多次系统异常。本报告详细记录了这些问题的排查过程与最终解决方案，以备项目归档。

## 2. 异常案例与诊断分析

### 2.1 界面逻辑类：看板数据无法加载
- **异常描述**：打开可视化演示界面后，仪表盘图表显示为 0，且拖动无反应。
- **诊断过程**：追踪 `FormChart` 的初始化流程，发现虽然建立了 UI，但主窗体 `Form1` 的引用（`SetMainForm`）在图表首轮刷新之后才传入。
- **解决方案**：在 `SetMainForm` 注入实例的同时，立即手动触发一次 `UpdateChartData`。

### 2.2 编译环境类：方法丢失 (CS1061)
- **异常描述**：提示 `Form1` 不包含 `GetCountByCity` 的定义，尽管文件已存在。
- **诊断过程**：检查 `.csproj` 文件，发现 `Form1.Data.cs` 文件虽在磁盘上，但未被 VS 项目系统加载（非 `<Compile>` 项）。
- **解决方案**：手动修改项目配置文件，重新链接数据中台代码文件。

### 2.3 核心算法类：时间过滤失效 (始终 185 条)
- **异常描述**：拖动时间轴，统计数量始终保持最大值（185），无法体现时空演变。
- **诊断过程**：
    1.  **数据类型误判**：SHP 中的 `公布时间` 是 Double 型，而 SQL 拼接使用了字符串 `'2005'`，导致部分数据库引擎忽略条件。
    2.  **量纲错误**：数据中 `公布时间` 字段存的是批次号（1, 2, 3...）。当滑块为 2008 时，`1 <= 2008` 永远成立。
- **解决方案**：
    - 开发了“双模逻辑查询”：自动判断字段是“年份”还是“批次”。
    - 年份映射：根据滑块年份自动计算并对比对应的国家级非遗批次（例如 2006 -> 1）。

### 2.4 ArcGIS 交互类：定位不到城市或显示红色错误
- **异常描述**：点击图表柱子无反应，或者图表标题显示红色错误“定位异常”。
- **诊断过程**：
    1.  **字段名不匹配**：代码初期假设字段名为“行政名”，但实际 SHP 属性表字段可能为“行政名称”或“NAME”。
    2.  **图层类型错选**：点击“聊城市”仅缩放到一个点。原因是代码选错了“名录点图层”进行定位，而非“行政区划面图层”。
- **解决方案**：
    - **逻辑增强**：升级了双循环字段搜索算法，支持“行政名称”、“NAME”等 10 余种常见 GIS 字段名，且具备模糊匹配能力（`LIKE '%济南%'`）。
    - **几何类型降级策略**：开发了“面图层优先、点图层降级”搜索算法。优先寻找多边形（Polygon）图层以显示完整边界；若无面层，则自动寻找点图层并通过 `Envelope.Expand` 自动拉大视野，确保不会报错。

### 2.5 集成界面类：地图显示范围过窄或选择错误
- **异常描述**：点击地图时出现“全选”或者误操作弹出空白窗。
- **解决方案**：在 `AxMapControlVisual_OnMouseDown` 中加入图层过滤，仅允许对包含“非遗”关键词的业务图层进行点击详情查询，避免了点击到底图（BaseMap）导致的逻辑异常。

## 3. 质量控制总结
通过本次调试，系统实现了：
- **数据真实性**：拒绝人工编造数据，完全基于 ArcGIS 引擎实时读取 `公布时间` 原始指标。
- **鲁棒性**：能够自动识别多种字段名（如“市”、“NAME”、“XZQ_NAME”等），具备良好的 Shapefile 适配能力。
- **即时反馈**：将调试信息集成到图表标题中，即便数据源异常，也能提示用户缺失的具体字段。

---
**核准人**：[Member B]
**状态**：已修复，可交付。
