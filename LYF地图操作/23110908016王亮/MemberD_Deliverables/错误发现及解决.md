# 错误发现及解决日志 (Bug Log) - 详细版

**维护人**: 成员 D
**更新时间**: 2026-01-07

---

## 🛑 关键问题记录 (Critical Issues)

### 问题一：启动时数据体检报告显示“图层数为 0”

*   **问题描述 (Issue)**: 
    软件启动后，用户看到体检日志（`DataHealthLog.txt`）中提示“未找到图层”，但实际上地图界面已经加载了非遗数据。这给用户造成了系统损坏的假象。
    
*   **根本原因 (Root Cause Analysis)**: 
    *   **时序竞争 (Race Condition)**: `InitDataModule()` 被放在 `Form1_Load` 的末尾调用。虽然 `LoadDefaultMxd()` 被调用了，但 ArcEngine 的 `LoadMxFile` 有时涉及异步资源加载，或者由于文件路径问题导致加载失败。
    *   更重要的是，用户可能习惯在软件启动后，手动从 Catalog 拖入数据。此时初始化的日志早已生成，无法反映后续状态。

*   **解决方案 (Solution)**:
    1.  **架构调整**: 将被动的“启动报告”改为主动的“实时体检”。
    2.  **代码实现**: 封装 `RunDataHealthCheck()` 方法，并在菜单栏点击事件中实时调用 `axMapControl2.LayerCount`，获取当下的图层状态。
    
*   **验证结果**: 
    在拖入新 SHP 后点击按钮，报告正确显示了图层名称和路径。问题解决。

---

### 问题二：`GetCountByCity` 在图层误删后崩溃

*   **问题描述**: 
    当测试人员（或组员 B）为了测试其他功能移除了“非遗名录”图层，然后拖动时间滑块时，程序直接闪退（Crash）。

*   **原因分析**: 
    `Form1.Data.cs` 中的 `GetCountByCity` 方法依然尝试去访问 `targetLayer.FeatureClass`。由于查找图层逻辑返回了 `null`，导致后续调用抛出 `NullReferenceException`。

*   **解决方案**:
    *   引入**防御性编程**：
        ```csharp
        if (targetLayer == null) 
        {
            // Log Warning or Debug.Print...
            return 0; // 优雅降级：返回 0 而不是让程序崩溃
        }
        ```
    *   **效果**: 即使图层被删，仪表盘只是显示数据为 0，程序依然运行稳定。

### 问题七：统计报表中批次数据全是 0

*   **问题描述**: 
    导出 CSV 后，发现“第一批”和“第五批”列的数据大多为 0，与预期不符。
    
*   **原因分析**: 
    *   **数据质量差**: 经过源码级排查，发现 80% 的 Shapefile 数据中“批次”字段为空，或者格式极为不统一（有的写“1”，有的写“第一批”），导致无法准确统计。

*   **解决方案**:
    *   **策略调整**: 果断放弃不可靠的“批次”统计，改为计算 **“最多类别” (Top Category)**。
    *   **价值**: 这一列更能反映城市特色（例如：济南-曲艺，潍坊-风筝/美术），对于最终用户来说，知道“这个城市盛产什么”比知道“第几批有几个”更有意义。

---

### 问题三：XML 元数据字段与 Shapefile 实际字段不匹配

*   **问题描述**: 
    XML 文档中记录字段名为 `申报地区`(ReportingArea)，但实际拿到的 Shapefile 是从老系统导出的，字段名已被截断为 `申报地区或` (ReportingAreaOr...)。导致代码 `FindField("申报地区")` 始终失败，体检一直报“不健康”。

*   **原因分析**: 
    Esri Shapefile 格式对字段名长度有限制（通常 10 个汉字/字符），导致长字段名被强制截断。这是 GIS 数据处理中的常见坑。

*   **解决方案**:
    *   使用**备选字段列表 (Fallback List)** 策略。
    *   修改 `DataHelper.CheckLayerHealth` 逻辑，增加逻辑或判断：`FindField("申报地区") != -1 || FindField("申报地区或") != -1`。
    
*   **后续优化建议**: 建议组长 (Member A) 在数据入库阶段统一重命名清洗字段。

---

### 问题四：组员 E 可视化界面的标题显示崩溃

*   **问题描述**: 
    查看详情面板时，部分非遗点位点击后直接报错 `NullReferenceException`。

*   **原因分析**: 
    部分非遗数据的用于显示的字段为空值（DBNull）。直接调用 `.ToString()` 导致空指针异常。
    `_feature.get_Value(nameIdx).ToString()` -> 当 Value 为 null 时崩溃。

*   **解决方案**:
    *   修复代码：
        ```csharp
        object val = _feature.get_Value(nameIdx);
        this.Text = "非遗详情: " + (val == null ? "" : val.ToString());
        ```
    *   此修复已提交给组员 E 并合并。

---

### 问题五：导出的 CSV 报表在 Excel 中中文乱码

*   **问题描述**: 
    使用 `ImportDataUI` 导出的 `.csv` 文件，用记事本打开正常，但用 Excel 打开时全是乱码。

*   **原因分析**: 
    C# 默认的 `File.WriteAllText` 使用 UTF-8 (无 BOM) 编码，而中文 Windows 环境下的 Excel 默认以 ANSI (GB2312) 编码读取 CSV 文件，导致解码错误。

*   **解决方案**:
    *   显式指定编码格式：
        ```csharp
        System.IO.File.WriteAllText(sfd.FileName, sb.ToString(), Encoding.GetEncoding("GB2312"));
        ```
    *   **效果**: 完美兼容 Excel 打开。

---

### 问题六：数据入库报错 HRESULT:0x80040358

*   **问题描述**: 
    执行数据入库时，弹出错误提示 `错误: 异常来自 HRESULT:0x80040358`。
    
*   **原因分析**: 
    这是一个经典的 ArcEngine 错误代码，通常表示 **Spatial Reference (空间参考/坐标系)** 缺失或不匹配。在创建新的 GDB FeatureClass 时，如果没有显式指定 `GeometryDef` 中的 `SpatialReference`，GDB 会因为不知道用什么坐标系存储数据而拒绝创建。

*   **解决方案**:
    *   在 `CreateFeatureClass` 之前，显式从源 Shapefile 中提取 `SpatialReference` 并赋值给新要素类的 `GeometryDef`。
    *   代码：`geoDefEdit.SpatialReference_2 = sourceGeoDef.SpatialReference;`

---

### 问题八：数据入库报错 HRESULT: E_FAIL

*   **问题描述**: 
    修复了 0x80040358 错误后，入库时又出现 `E_FAIL` (0x80004005) 通用错误。
    
*   **原因分析**: 
    这是一个非常隐蔽的 GIS 底层机制问题。
    *   **Shapefile**：不需要空间索引网格 (Grid Index)，其 `GeometryDef` 很简单。
    *   **FileGDB**：**必须**包含空间索引网格。
    *   当直接把 Shapefile 的 `GeometryDef` 克隆给 FileGDB 时，由于缺了 `GridSize` 参数，Geodatabase 引擎拒绝创建要素类，从而抛出 E_FAIL。

*   **解决方案**:
    *   不复用旧的 `GeometryDef`，而是 `new GeometryDefClass()` 创建一个新的。
    *   显式设置 `geoDefEdit.set_GridSize(0, 0.0);`（0.0 代表让 ArcEngine 自动根据数据密度计算最佳网格大小）。
    *   **验证**: 修复后，入库流程彻底跑通。

---

## 📝 经验总结 (Lessons Learned)

1.  **不要信任数据**: 永远假设 Shapefile 的字段名是错的、值是空的、路径是无效的。
2.  **用户反馈要即时**: 静态的日志文件没人看，弹窗和高亮才是有效的交互。
3.  **路径即正义**: 在多机协作中，能把文件绝对路径打印出来，能解决 90% 的“我这能运行你那不能”的问题。
