# 数据质量检查工具使用说明

**创建日期**: 2025-12-30  
**工具位置**: `数据加载` → `检查数据质量` (需要在Designer中添加菜单项)

---

## 功能说明

这个工具用于检查非遗数据中是否存在**重复位置**的问题,即多个非遗项目具有完全相同或非常接近的地理坐标。

### 为什么需要检查?

重复位置会导致以下问题:
1. **统计分析不准确**: 按市统计非遗数量时,同一位置的多个项目会被重复计数
2. **热力图显示异常**: 同一位置权重过高,导致热力图失真
3. **搜索功能异常**: 可能只显示第一个匹配项,其他项目被忽略
4. **可视化效果差**: 标注重叠,难以辨认

---

## 如何使用

### 方法1: 通过菜单调用 (推荐)

1. 在TOC(图层列表)中**右键点击**要检查的图层
2. 选择 `数据加载` → `检查数据质量`
3. 等待分析完成,查看报告

### 方法2: 自动检测非遗图层

1. 如果没有选中图层,工具会自动查找名称包含"非遗"、"ICH"、"项目"或"遗产"的图层
2. 直接点击菜单项即可

---

## 报告内容解读

### 基本信息
```
图层名称: 国家级非物质文化遗产代表性项目名录
总要素数: 1557
使用字段: 项目名称
```

### 统计结果
```
扫描完成: 共 1557 个要素
唯一位置数: 1450
重复位置数: 107
```

**解读**:
- **唯一位置数**: 有多少个不同的地理位置
- **重复位置数**: 有多少个位置存在重复(多个要素在同一位置)

### 重复位置详情

```
位置 #1: (118.123456, 36.654321)
重复数量: 3 个要素
包含项目:
  - OID:123 | 木版年画 [名称字段包含多个项目!]
  - OID:124 | 剪纸
  - OID:125 | 皮影戏
```

**标记说明**:
- `[名称字段包含多个项目!]`: 表示这条记录的名称字段用分号、逗号等分隔了多个项目名称,这是**数据录入错误**

---

## 问题类型判断

### 类型1: 名称字段包含多个项目 ❌

**特征**: 报告中显示 `[名称字段包含多个项目!]`

**示例**:
```
项目名称: "木版年画;剪纸;皮影戏"
```

**原因**: 数据录入时,把多个项目写在了一个字段里

**解决方案**: 
1. 在ArcMap中打开属性表
2. 找到对应的OID记录
3. 将名称字段拆分,每个项目一条记录
4. 或者删除多余的项目名称,只保留一个

### 类型2: 多个项目确实在同一位置 ✓

**特征**: 多条记录,每条记录名称不同,但坐标相同

**示例**:
```
位置: (118.123456, 36.654321)
  - OID:123 | 木版年画
  - OID:124 | 剪纸
  - OID:125 | 皮影戏
```

**原因**: 可能是:
- 同一个传承基地有多个非遗项目
- 同一个文化馆管理多个项目
- 数据录入时使用了代表性坐标(如市政府位置)

**解决方案**:
1. **如果是真实情况**: 保持不变,但在统计时需要注意
2. **如果是录入错误**: 需要修正每个项目的真实坐标
3. **如果是代表性坐标**: 考虑:
   - 为每个项目添加微小偏移(如0.0001度)
   - 或者合并为一条记录,添加"项目数量"字段
   - 或者在可视化时使用聚合(Cluster)显示

---

## 数据修正建议

### 方案1: 拆分记录 (推荐)

适用于"名称字段包含多个项目"的情况

1. 在ArcMap中开始编辑
2. 找到问题记录
3. 复制该记录N次(N=项目数量)
4. 每条记录只保留一个项目名称
5. 如果需要,为每个项目添加微小的坐标偏移

### 方案2: 添加项目数量字段

适用于"多个项目确实在同一位置"的情况

1. 在属性表中添加新字段 `项目数量`
2. 对于重复位置,只保留一条记录
3. 将项目数量填入该字段
4. 统计时使用该字段进行加权

### 方案4: 坐标离散化 (Displacement) [已实施 ✅]

针对“一个坐标点对应多个非遗项目”的现状,采用了**坐标离散化**核心算法:
- **逻辑**: 检测所有经纬度完全重叠的点,保持第一个项目原位,其余项目均匀分布在半径约50-80米的圆周上。
- **优点**: 
  - 视觉上图标不再重叠。
  - 标注(Label)会自动分散,不再模糊一团。
  - 每个点都可以被单独点击查询。
- **集成**: 已集成在“一键初始化非遗数据”步骤中,全自动完成。

1. 在符号化设置中启用"聚合"功能
2. 设置聚合半径
3. 自动将同一位置的多个点合并显示

---

## 注意事项

1. **备份数据**: 修改数据前一定要备份!
2. **检查原因**: 先判断是数据错误还是真实情况
3. **影响范围**: 修正数据后,记得重新生成统计图表和热力图
4. **定期检查**: 建议每次导入新数据后都运行一次检查

---

## 技术细节

### 位置精度

工具使用**6位小数**的精度来判断位置是否相同:
- 经纬度6位小数 ≈ 0.1米的精度
- 如果两个点的坐标在0.1米范围内,视为同一位置

### 性能

- 小数据集(< 10000条): 几秒内完成
- 大数据集(> 10000条): 可能需要几十秒

### 报告限制

- 默认只显示前20个重复位置
- 如果重复位置过多,会显示省略提示
